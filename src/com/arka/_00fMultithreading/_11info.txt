/******** Deadlock ********/

/** Deadlock is a special type of error that need to avoid that relates specifically

    to multitasking. It mainly occurs when two threads have a circular dependency on

    a pair of synchronized objects.

**/

class A{
	synchronized void foo(B b){
		String name = Thread.currentThread().getName();
		System.out.println(name + "entered A.foo");
		try{
			Thread.sleep(1000);

		}catch(InterruptedException e){

			System.out.println("A interrupted");

		}
		System.out.println(name + " try to call B.last()");
		b.last();

	}
	synchronized void last(){
		System.out.println("Inside A.last");
	}

}

class B{
	synchronized void bar(A a){
		String name = Thread.currentThread().getName();
		System.out.println(name + "entered B.bar");
		try{
			Thread.sleep(1000);

		}catch(InterruptedException e){
			System.out.println("B interrupted");
		}
		System.out.println(name + " try to call A.last()");
		a.last();
	}
	synchronized void last(){
		System.out.println("Inside B.last");
	}
}

class Deadlock implements Runnable{
	A a = new A();
	B b = new B();

	Deadlock(){
		Thread.currentThread().setName("Main Thread");
		Thread t = new Thread(this, "Child Thread");
		t.start();
		a.foo(b);
		System.out.println("Back in main thread");
	}
	public void run(){
		b.bar(a);
		System.out.println("Back in child thread");
	}
	public static void main(String args[]){
	    new Deadlock();
	}
}

/****** Interthread Communication ******/
/*
 * Three methods :
 * 1. final void wait() throws InterruptedException
 * 2. final void notify()
 * 3. final void notifyAll()
 *
 * wait() :
 *   tells calling thread to give up the monitor and go to sleep until
 *   some other thread enters the same monitor and calls notify().
 *
 * notify() :
 *   wakes up a thread that called wait() on the same object.
 *
 * notifyAll() :
 *   wakes up all the threads that called wait() on the same object.
 */
/**** Example : Producer / Consumer problem ****/
class Q {
    int n;

    synchronized int get() {
        System.out.println("Got : " + n);
        return n;
    }

    synchronized void put(int n) {
        this.n = n;
        System.out.println("Put : " + n);
    }
}

class Producer implements Runnable {
    Q q;

    Producer(Q q) {
        this.q = q;
        new Thread(this, "Producer").start();
    }

    public void run() {
        int i = 0;

        while (true) {
            q.put(++i);
        }
    }
}
class Consumer implements Runnable {
    Q q;

    Consumer(Q q) {
        this.q = q;
        new Thread(this, "Consumer").start();
    }

    public void run() {
        while (true) {
            q.get();
        }
    }
}
class PC {
    public static void main(String args[]) {
        Q q = new Q();

        new Producer(q);
        new Consumer(q);

        System.out.println("Press ctrl-c to stop");
    }
}
______________________________________________________________________________________________
class Q {
    int n;
    boolean valueset = false;

    synchronized int get() {
        if (!valueset) {
            try {
                wait();
            } catch (InterruptedException e) {
                System.out.println("Interrupted Exception caught");
            }
        }

        System.out.println("Got : " + n);
        valueset = false;
        notify();
        return n;
    }

    synchronized void put(int n) {
        if (valueset) {
            try {
                wait();
            } catch (InterruptedException e) {
                System.out.println("Interrupted Exception caught");
            }
        }

        this.n = n;
        valueset = true;
        System.out.println("Put : " + n);
        notify();
    }
}

class Producer implements Runnable {
    Q q;

    Producer(Q q) {
        this.q = q;
        new Thread(this, "Producer").start();
    }

    public void run() {
        int i = 0;

        while (true) {
            q.put(++i);
        }
    }
}

class Consumer implements Runnable {
    Q q;

    Consumer(Q q) {
        this.q = q;
        new Thread(this, "Consumer").start();
    }

    public void run() {
        while (true) {
            q.get();
        }
    }
}

class PC1 {
    public static void main(String args[]) {
        Q q = new Q();

        new Producer(q);
        new Consumer(q);

        System.out.println("Press ctrl-c to stop");
    }
}
